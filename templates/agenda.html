<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Agenda</title>
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

    <!-- Custom CSS -->
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f9;
        }

        #calendar-container {
            width: 90%; /* Slightly larger width */
            max-width: 1200px; /* Increased max width */
            margin: 20px auto;
            background: #ffffff;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
        }

        #calendar {
            height: 100%; /* Ensure the calendar takes up the full height */
        }

        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div id="calendar-container">
        <h1>Your Weekly Agenda</h1>
        <div id="calendar"></div>
    </div>

    <!-- Edit/Delete Event Popup -->
    <div id="event-popup" style="display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 99999;">
        <h3>Edit Event</h3>
        <form id="edit-event-form">
            <input type="hidden" id="event-id" name="id">
            <label for="event-title">Title:</label>
            <input type="text" id="event-title" name="title" required><br>
            <label for="event-color">Color:</label>
            <input type="color" id="event-color" name="color"><br>
            <label for="event-start">Start:</label>
            <input type="datetime-local" id="event-start" name="start" required><br>
            <label for="event-end">End:</label>
            <input type="datetime-local" id="event-end" name="end"><br>
            <button type="submit">Save</button>
            <button type="button" onclick="deleteEvent()">Delete</button>
            <button type="button" onclick="closePopup('event-popup')">Cancel</button>
        </form>
    </div>

    <!-- Create Event Popup -->
    <div id="create-popup" style="display: none; position: fixed; top: 20%; left: 50%; transform: translate(-50%, -20%); background: white; padding: 20px; border: 1px solid #ddd; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1); z-index: 99999;">
        <h3>Create Event</h3>
        <form id="create-event-form">
            <label for="create-title">Title:</label>
            <input type="text" id="create-title" name="title" required><br>
            <label for="create-color">Color:</label>
            <input type="color" id="create-color" name="color"><br>
            <label for="create-start">Start:</label>
            <input type="datetime-local" id="create-start" name="start" required><br>
            <label for="create-end">End:</label>
            <input type="datetime-local" id="create-end" name="end"><br>
            <button type="submit">Create</button>
            <button type="button" onclick="closePopup('create-popup')">Cancel</button>
        </form>
    </div>

    <!-- FullCalendar Initialization -->
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const calendarEl = document.getElementById('calendar');
            const calendar = new FullCalendar.Calendar(calendarEl, {
                initialView: 'timeGridWeek',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'timeGridMonth,timeGridWeek,timeGridDay' // Allow switching between week and day views
                },
                height: 'auto', // Automatically adjust height to fit content
                slotLabelFormat: { // Format for time slots (24-hour format)
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                eventTimeFormat: { // Format for event times (24-hour format)
                    hour: '2-digit',
                    minute: '2-digit',
                    hour12: false
                },
                events: async function (fetchInfo, successCallback, failureCallback) {
                    try {
                        const response = await fetch('/api/events');
                        const events = await response.json();
                        successCallback(events);
                    } catch (error) {
                        console.error('Error fetching events:', error);
                        failureCallback(error);
                    }
                },
                eventClick: function (info) {
                    // Open the edit/delete popup
                    openEventPopup(info.event);
                },
                dateClick: function (info) {
                    // Open the create event popup
                    const endTime = new Date(info.date);
                    const timezoneOffset = endTime.getTimezoneOffset() / 60; // Get timezone offset in hours
                    endTime.setHours(endTime.getHours() + 1 - timezoneOffset); // Adjust end time to be 1 hour later
                    openCreatePopup(info.dateStr.slice(0, 16), endTime.toISOString().slice(0, 16)); // Format date for input
                }
            });
            calendar.render();

            // Function to open the edit/delete popup
            function openEventPopup(event) {
                const popup = document.getElementById('event-popup');
                document.getElementById('event-id').value = event.id;
                document.getElementById('event-title').value = event.title;
                document.getElementById('event-color').value = event.backgroundColor;
                document.getElementById('event-start').value = event.start.toISOString().slice(0, 16);
                document.getElementById('event-end').value = event.end ? event.end.toISOString().slice(0, 16) : '';
                popup.style.display = 'block';
            }

            // Function to open the create event popup
            function openCreatePopup(dateStr, endTime) {
                const popup = document.getElementById('create-popup');
                document.getElementById('create-start').value = dateStr;
                document.getElementById('create-end').value = endTime;
                popup.style.display = 'block';
            }
        });
    </script>

    <script>
        // Close popup function
        function closePopup(popupId) {
            document.getElementById(popupId).style.display = 'none';
        }

        // Delete event function
        async function deleteEvent() {
            const eventId = document.getElementById('event-id').value;
            await fetch(`/api/events/${eventId}`, { method: 'DELETE' });
            location.reload();
        }

        // Handle form submissions
        document.getElementById('edit-event-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await fetch('/api/events', {
                method: 'PUT',
                body: JSON.stringify(Object.fromEntries(formData)),
                headers: { 'Content-Type': 'application/json' }
            });
            location.reload();
        });

        document.getElementById('create-event-form').addEventListener('submit', async function (e) {
            e.preventDefault();
            const formData = new FormData(e.target);
            await fetch('/api/events', {
                method: 'POST',
                body: JSON.stringify(Object.fromEntries(formData)),
                headers: { 'Content-Type': 'application/json' }
            });
            location.reload();
        });
    </script>
</body>
</html>