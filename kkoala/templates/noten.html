{% extends "base.html" %}

{% block title %}Notenverwaltung{% endblock %}

{% block meta %}
<!--
    CSRF token meta tag for AJAX requests and form security.
    Ensures secure POST/PUT/DELETE operations from JavaScript.
-->
<meta name="csrf-token" content="{{ session.get('csrf_token', '') }}">
{% endblock %}

{% block content %}
<!--
    Notenverwaltung (Grade Management) Page
    - Allows users to manage semesters, subjects, and grades.
    - Provides modals for adding/editing/deleting grades, subjects, and semesters.
    - Includes a dream grade calculator and supports drag-and-drop sorting.
    - Uses Tailwind CSS for styling and supports dark mode.
-->

<!-- Header with page title and add semester button -->
<div class="flex justify-between items-center flex-wrap gap-4 mb-8">
    <h1 class="text-3xl sm:text-4xl font-bold text-zinc-800 dark:text-white">Notenverwaltung</h1>
    <button onclick="createSemester()" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 dark:focus:ring-offset-zinc-900 shrink-0">
        Semester hinzufügen
    </button>
</div>

<!-- Semesters will be rendered here by JavaScript -->
<div id="semesters" class="space-y-6"></div>

<!-- Overlay for all modals -->
<div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

<!-- Grade Add/Edit Modal -->
<div id="grade-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
    <h3 id="grade-popup-title" class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Note hinzufügen</h3>
    <div class="space-y-4">
        <input type="text" id="gradeName" placeholder="Notenname" maxlength="100" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="number" id="gradeValue" placeholder="Note (1.0-6.0)" step="0.01" min="1" max="6" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="number" id="gradeWeight" placeholder="Gewichtung" step="0.01" value="1" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <label class="flex items-center space-x-2 text-zinc-700 dark:text-zinc-300">
            <input type="checkbox" id="gradeCounts" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span>Zählt zum Fachdurchschnitt</span>
        </label>
    </div>
    <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeGradePopup()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button id="grade-popup-save-btn" onclick="addOrEditGradeToSubject()" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Hinzufügen</button>
    </div>
</div>

<!-- Subject Edit Modal -->
<div id="subject-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
    <h3 class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Fach bearbeiten</h3>
    <div class="space-y-4">
        <input type="text" id="subjectNameEdit" placeholder="Fachname" maxlength="100" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <label class="flex items-center space-x-2 text-zinc-700 dark:text-zinc-300">
            <input type="checkbox" id="subjectCountsAverage" checked class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
            <span>Zählt zum Semesterdurchschnitt</span>
        </label>
    </div>
    <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeSubjectPopup()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button onclick="saveSubjectEdit()" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Speichern</button>
    </div>
</div>

<!-- Delete Confirmation Modal for Semester -->
<div id="delete-confirm-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50 text-center">
    <h3 id="confirm-semester-name" class="text-2xl font-bold text-zinc-900 dark:text-white mb-4">Löschen bestätigen</h3>
    <p class="text-zinc-600 dark:text-zinc-300 mb-6">Sind Sie sicher, dass Sie dies und alle Inhalte löschen möchten?</p>
    <div class="flex justify-center space-x-3">
        <button onclick="closeDeleteConfirm()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button id="confirm-delete-btn" onclick="confirmDeleteSemester()" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Ja, löschen</button>
    </div>
</div>

<!-- Dream Grade Calculator Modal -->
<div id="dream-calc-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
    <h3 id="dream-calc-subject-name" class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Wunschnoten-Rechner</h3>
    <div class="space-y-4">
        <input type="number" id="wishedAvgInput" placeholder="Wunschnote (z.B. 4.5)" step="0.1" min="1" max="6" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <input type="number" id="nextWeightInput" placeholder="Gewichtung der nächsten Note (z.B. 1)" step="0.1" min="0.1" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
        <button onclick="calculateDreamGradeFromPopup()" class="w-full px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Benötigte Note berechnen</button>
        <p id="neededGradeOutput" class="text-center font-bold text-orange-600 dark:text-orange-400 mt-4 h-6">Benötigte Note: -</p>
    </div>
    <div class="flex justify-end mt-6">
        <button onclick="closeDreamCalcPopup()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Schliessen</button>
    </div>
</div>

<!-- Semester Rename Modal -->
<div id="semester-rename-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
    <h3 class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Semester umbenennen</h3>
    <div class="space-y-4">
        <input type="text" id="semesterNameEdit" placeholder="Semestername" maxlength="100" class="w-full px-4 py-2 text-zinc-900 bg-zinc-100 dark:bg-zinc-700 dark:text-white border border-zinc-300 dark:border-zinc-600 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
    </div>
    <div class="flex justify-end space-x-3 mt-6">
        <button onclick="closeSemesterRenamePopup()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button onclick="saveSemesterRename()" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">Speichern</button>
    </div>
</div>

<!-- Subject Delete Confirmation Modal -->
<div id="delete-subject-confirm-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50 text-center">
    <h3 id="confirm-subject-name" class="text-2xl font-bold text-zinc-900 dark:text-white mb-4">Fach löschen bestätigen</h3>
    <p class="text-zinc-600 dark:text-zinc-300 mb-6">Sind Sie sicher, dass Sie dieses Fach und alle Noten löschen möchten?</p>
    <div class="flex justify-center space-x-3">
        <button onclick="closeDeleteSubjectConfirm()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button onclick="confirmDeleteSubject()" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Ja, löschen</button>
    </div>
</div>

<!-- Grade Delete Confirmation Modal -->
<div id="delete-grade-confirm-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50 text-center">
    <h3 id="confirm-grade-name" class="text-2xl font-bold text-zinc-900 dark:text-white mb-4">Note löschen bestätigen</h3>
    <p class="text-zinc-600 dark:text-zinc-300 mb-6">Sind Sie sicher, dass Sie diese Note löschen möchten?</p>
    <div class="flex justify-center space-x-3">
        <button onclick="closeDeleteGradeConfirm()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Abbrechen</button>
        <button onclick="confirmDeleteGrade()" class="px-4 py-2 font-semibold text-white bg-red-600 rounded-lg hover:bg-red-700">Ja, löschen</button>
    </div>
</div>
{% endblock %}

{% block scripts %}
<!--
    JavaScript for Notenverwaltung functionality.
    - Handles all grade/subject/semester CRUD operations and modals.
    - Enables drag-and-drop sorting with SortableJS.
-->
<script src="{{ url_for('static', filename='js/noten.js') }}"></script>
<script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.0/Sortable.min.js"></script>
{% endblock %}