<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ session.csrf_token }}">
    <title>Semester Management</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
        }
        .semester, .subject {
            border: 1px solid #ccc;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 6px;
            background: #fafafa;
        }
        .dropdown-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #f0f0f0;
            padding: 8px;
            border-radius: 4px;
        }
        .dropdown-content {
            display: none;
            margin-top: 8px;
        }
        .dropdown-header.open + .dropdown-content {
            display: block;
        }
        .grade-row {
            display: flex;
            gap: 10px;
            align-items: center;
            margin-bottom: 5px;
        }
        .average {
            font-weight: bold;
            color: #2a7a2a;
        }
        .add-btn {
            margin-top: 8px;
        }
        /* Style for all popups and overlay */
        .popup, .overlay {
            display: none;
            position: fixed;
            z-index: 1000;
        }
        .popup {
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            padding: 20px;
            z-index: 1001;
            min-width: 250px;
            text-align: center;
        }
        .overlay {
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
        }
        .edit-btn, .delete-btn {
            margin-left: 5px;
        }
        .dream-average-calculator input {
            margin-bottom: 5px;
            width: 150px;
            padding: 5px;
        }
        .needed-grade-output {
            font-weight: bold;
            color: #d85f00;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <h1>Semester Management</h1>
    <button onclick="createSemester()">Add Semester</button>
    <div id="semesters"></div>

    <div class="overlay" id="overlay"></div>

    <div class="popup" id="grade-popup">
        <h3 id="grade-popup-title">Add Grade</h3>
        <input type="text" id="gradeName" placeholder="Grade Name"><br>
        <input type="number" id="gradeValue" placeholder="Grade (1.0-6.0)" step="0.01" min="1" max="6"><br>
        <input type="number" id="gradeWeight" placeholder="Weightage" step="0.01" value="1"><br>
        <label>
            <input type="checkbox" id="gradeCounts" checked>
            Counts towards subject average
        </label><br>
        <button id="grade-popup-save-btn" onclick="addOrEditGradeToSubject()">Add</button>
        <button onclick="closeGradePopup()">Cancel</button>
    </div>

    <div class="popup" id="subject-popup">
        <h3>Edit Subject</h3>
        <input type="text" id="subjectNameEdit" placeholder="Subject Name"><br>
        <label>
            <input type="checkbox" id="subjectCountsAverage" checked>
            Counts towards semester average
        </label><br>
        <button onclick="saveSubjectEdit()">Save</button>
        <button onclick="closeSubjectPopup()">Cancel</button>
    </div>

    <div class="popup" id="delete-confirm-popup">
        <h3 id="confirm-semester-name">Confirm Deletion</h3>
        <p>Are you sure you want to delete this semester and all its subjects/grades?</p>
        <button id="confirm-delete-btn" onclick="confirmDeleteSemester()">Yes, Delete</button>
        <button onclick="closeDeleteConfirm()">Cancel</button>
    </div>
    
    <div class="popup" id="dream-calc-popup">
        <h3 id="dream-calc-subject-name">Dream Grade Calculator</h3>
        <div class="dream-average-calculator">
            <input type="number" id="wishedAvgInput" placeholder="Wished Avg (e.g., 4.5)" step="0.1" min="1" max="6"><br>
            <input type="number" id="nextWeightInput" placeholder="Next Grade Weight (e.g., 1)" step="0.1" min="0.1"><br>
            <button onclick="calculateDreamGradeFromPopup()">Calculate Needed Grade</button>
            <p id="neededGradeOutput" class="needed-grade-output">Needed Grade: -</p>
        </div>
        <button onclick="closeDreamCalcPopup()">Close</button>
    </div>

    <script>
        // --- Hardcoded Data ---
        const SEMESTER_NAMES = ["Semester 1", "Semester 2", "Semester 3", "Semester 4", "Semester 5", "Semester 6", "Semester 7", "Semester 8"];
        const subjectsBySemesterName = {
            "Semester 1": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Geografie", "Sport", "Englisch", "Französisch", "Informatik", "Wirtschaft und Recht", "Geschichte"],
            "Semester 2": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Geografie", "Sport", "Englisch", "Französisch", "Informatik", "Wirtschaft und Recht", "Geschichte"],
            "Semester 3": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Geografie", "Sport", "Englisch", "Französisch", "Informatik", "Wirtschaft und Recht", "Geschichte"],
            "Semester 4": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Geografie", "Sport", "Englisch", "Französisch", "Informatik", "Wirtschaft und Recht", "Geschichte"],
            "Semester 5": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Sport", "Englisch", "Französisch", "Geschichte"],
            "Semester 6": ["Deutsch", "Mathematik", "Biologie", "Chemie", "Sport", "Englisch", "Französisch", "Geschichte"],
            "Semester 7": ["Deutsch", "Mathematik", "Sport", "Physik", "Englisch", "Französisch", "Geschichte"],
            "Semester 8": ["Deutsch", "Mathematik", "Sport", "Physik", "Englisch", "Französisch", "Geschichte"]
        };
        
        // --- Global State Variables ---
        let semesterCounter = 0; 
        let currentSubjectForGrade = null;
        let editingGradeRow = null;
        let editingSubjectHeader = null;
        let editingSubjectContainer = null; 
        let semesterToDelete = null; 
        let currentSubjectForDreamCalc = null; // NEW: Context for the dream calculator

        // --- Plus Points Helper Functions ---

        /**
         * Rounds a grade to the nearest half point (X.0 or X.5).
         */
        function roundToHalf(grade) {
            return Math.round(grade * 2) / 2;
        }

        /**
         * Calculates plus points based on the rounded subject average.
         */
        function calculatePlusPoints(roundedGrade) {
            if (roundedGrade >= 4.0) {
                // 4.0 = 0 points, 4.5 = 0.5, 5.0 = 1.0, etc.
                return roundedGrade - 4.0;
            } else {
                // Below 4.0: 3.5 = -1, 3.0 = -2, 2.5 = -3, etc. (double the negative difference)
                return 2 * (roundedGrade - 4.0);
            }
        }

        // --- Confirmation Popup Functions ---

        function openDeleteConfirm(semesterDiv) {
            semesterToDelete = semesterDiv; 
            const semesterName = semesterDiv.querySelector('.dropdown-header span').textContent.trim();
            document.getElementById('confirm-semester-name').textContent = `Delete ${semesterName}?`;
            document.getElementById("overlay").style.display = "block";
            document.getElementById("delete-confirm-popup").style.display = "block";
        }

        function closeDeleteConfirm() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("delete-confirm-popup").style.display = "none";
            semesterToDelete = null; 
        }

        function confirmDeleteSemester() {
            if (semesterToDelete) {
                semesterToDelete.remove(); 
                saveAllSemestersToBackend();
            }
            closeDeleteConfirm();
        }

        // --- Dream Grade Calculator Popup Functions ---

        function openDreamCalcPopup(subjectDiv) {
            currentSubjectForDreamCalc = subjectDiv;
            const subjectName = subjectDiv.querySelector('.subject-title').textContent;
            document.getElementById('dream-calc-subject-name').textContent = `Wunschnote berechnen für ${subjectName}`;
            
            // Clear previous results/inputs for fresh start
            document.getElementById('wishedAvgInput').value = '';
            document.getElementById('nextWeightInput').value = '';
            document.getElementById('neededGradeOutput').textContent = 'Needed Grade: -';
            
            document.getElementById("overlay").style.display = "block";
            document.getElementById("dream-calc-popup").style.display = "block";
        }

        function closeDreamCalcPopup() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("dream-calc-popup").style.display = "none";
            currentSubjectForDreamCalc = null;
        }
        
        function calculateDreamGradeFromPopup() {
            const wishedAvg = parseFloat(document.getElementById('wishedAvgInput').value);
            const nextWeight = parseFloat(document.getElementById('nextWeightInput').value);
            const outputP = document.getElementById('neededGradeOutput');
            
            if (!currentSubjectForDreamCalc) {
                outputP.textContent = "Error: Subject context lost.";
                return;
            }

            if (isNaN(wishedAvg) || wishedAvg < 1 || wishedAvg > 6 || isNaN(nextWeight) || nextWeight <= 0) {
                outputP.textContent = "Error: Enter valid Avg (1-6) and Weight (>0).";
                return;
            }

            const gradesList = currentSubjectForDreamCalc.querySelector('.grades-list');

            let currentTotalScore = 0;
            let currentWeightSum = 0;
            
            gradesList.querySelectorAll(".grade-row").forEach(row => {
                if (row.dataset.counts === "true") {
                    currentTotalScore += parseFloat(row.dataset.value) * parseFloat(row.dataset.weight);
                    currentWeightSum += parseFloat(row.dataset.weight);
                }
            });

            // G_next = (WishedAvg * (CurrentWeightSum + NextWeight) - CurrentTotalScore) / NextWeight
            const desiredTotalScore = wishedAvg * (currentWeightSum + nextWeight);
            const requiredNextScore = desiredTotalScore - currentTotalScore;
            const neededGrade = requiredNextScore / nextWeight;
            
            let resultText;
            if (neededGrade > 6.0) {
                resultText = `Needed Grade: ${neededGrade.toFixed(2)} (Impossible)`;
            } else if (neededGrade < 1.0) {
                resultText = `Needed Grade: ${neededGrade.toFixed(2)} (Any grade >= 1.0)`;
            } else {
                resultText = `Needed Grade: ${neededGrade.toFixed(2)}`;
            }
            
            outputP.textContent = resultText;
        }

        // --- Core Subject/Semester Functions ---

        function createSemester() {
            if (semesterCounter >= SEMESTER_NAMES.length) {
                alert("Maximum number of hardcoded semesters reached.");
                return;
            }

            const semesterName = SEMESTER_NAMES[semesterCounter];
            
            const semesterDiv = document.createElement("div");
            semesterDiv.className = "semester";
            semesterDiv.dataset.id = Date.now();
            
            const header = document.createElement("div");
            header.className = "dropdown-header";
            header.innerHTML = `<span>${semesterName}</span><span class="average">Average: 0 | Points: 0.0</span>`;
            header.onclick = function() {
                header.classList.toggle("open");
                content.style.display = header.classList.contains("open") ? "block" : "none";
            };

            const content = document.createElement("div");
            content.className = "dropdown-content";
            content.style.display = "none";

            const subjectsContainer = document.createElement("div");
            subjectsContainer.className = "subjects-container";
            content.appendChild(subjectsContainer);
            
            const subjects = subjectsBySemesterName[semesterName] || [];
            subjects.forEach(subjectName => {
                const countsAverage = subjectName.toLowerCase() !== 'sport';
                addSubject(subjectsContainer, subjectName, [], countsAverage);
            });


            const addSubjectBtn = document.createElement("button");
            addSubjectBtn.textContent = "Add Subject";
            addSubjectBtn.className = "add-btn";
            addSubjectBtn.onclick = function() { addSubjectPrompt(subjectsContainer); };
            content.appendChild(addSubjectBtn);
            
            const deleteSemesterBtn = document.createElement("button");
            deleteSemesterBtn.textContent = "Delete Semester";
            deleteSemesterBtn.className = "delete-btn";
            deleteSemesterBtn.onclick = function() { openDeleteConfirm(semesterDiv); }; 
            content.appendChild(deleteSemesterBtn);


            semesterDiv.appendChild(header);
            semesterDiv.appendChild(content);
            document.getElementById("semesters").appendChild(semesterDiv);
            
            semesterCounter++;
            saveAllSemestersToBackend();
        }

        function addSubjectPrompt(container) {
            const subjectName = prompt("Enter subject name:");
            if (subjectName) {
                const countsAverage = subjectName.toLowerCase() !== 'sport';
                addSubject(container, subjectName, [], countsAverage);
            }
            saveAllSemestersToBackend();
        }

        function addSubject(container, subjectName, grades = [], countsAverage = true) {
            const subjectDiv = document.createElement("div");
            subjectDiv.className = "subject";
            subjectDiv.dataset.countsAverage = countsAverage; 

            const initialAvgDisplay = countsAverage ? 'Average: 0' : 'Non-Counting';
            const header = document.createElement("div");
            header.className = "dropdown-header";
            header.innerHTML = `<span class="subject-title">${subjectName}</span><span class="average">${initialAvgDisplay}</span>`;
            
            header.onclick = function(e) {
                if (e.target.classList.contains('edit-btn')) return;
                header.classList.toggle("open");
                content.style.display = header.classList.contains("open") ? "block" : "none";
            };

            const editSubjectBtn = document.createElement("button");
            editSubjectBtn.textContent = "Edit";
            editSubjectBtn.className = "edit-btn";
            editSubjectBtn.onclick = function(e) {
                e.stopPropagation();
                editingSubjectHeader = header.querySelector('.subject-title');
                editingSubjectContainer = subjectDiv; 
                
                document.getElementById("subjectNameEdit").value = editingSubjectHeader.textContent;
                document.getElementById("subjectCountsAverage").checked = subjectDiv.dataset.countsAverage === "true";
                
                document.getElementById("subject-popup").style.display = "block";
                document.getElementById("overlay").style.display = "block";
            };
            header.appendChild(editSubjectBtn);

            const content = document.createElement("div");
            content.className = "dropdown-content";
            content.style.display = "none";

            const gradesList = document.createElement("div");
            gradesList.className = "grades-list";
            content.appendChild(gradesList);
            
            grades.forEach(grade => renderGradeRow(gradesList, grade.name, grade.value, grade.weight, grade.counts));

            const addGradeBtn = document.createElement("button");
            addGradeBtn.textContent = "Add Grade";
            addGradeBtn.className = "add-btn";
            addGradeBtn.onclick = function() {
                currentSubjectForGrade = { 
                    gradesList, 
                    avgSpan: header.querySelector(".average"), 
                    semesterDiv: subjectDiv.closest('.semester') 
                };
                editingGradeRow = null;
                openGradePopup();
            };
            content.appendChild(addGradeBtn);

            const deleteBtn = document.createElement("button");
            deleteBtn.textContent = "Delete Subject";
            deleteBtn.className = "delete-btn";
            deleteBtn.onclick = function() { 
                subjectDiv.remove(); 
                updateSemesterAverage(subjectDiv.closest('.semester')); 
                saveAllSemestersToBackend(); 
            };
            content.appendChild(deleteBtn);
            
            // NEW: Dream Average Calculator Button
            const calculatorBtn = document.createElement("button");
            calculatorBtn.textContent = "Calculate Dream Grade";
            calculatorBtn.className = "add-btn";
            calculatorBtn.onclick = function() {
                openDreamCalcPopup(subjectDiv);
            };
            content.appendChild(calculatorBtn);


            subjectDiv.appendChild(header);
            subjectDiv.appendChild(content);
            container.appendChild(subjectDiv);
            
            updateSubjectAverage(gradesList, header.querySelector(".average"), subjectDiv.closest('.semester'));
        }
        
        // --- Subject/Grade Edit Popups and Handlers ---

        function openGradePopup(editRow = null) {
            document.getElementById("overlay").style.display = "block";
            document.getElementById("grade-popup").style.display = "block";
            editingGradeRow = editRow;
            if (editRow) {
                document.getElementById("grade-popup-title").textContent = "Edit Grade";
                document.getElementById("gradeName").value = editRow.dataset.name;
                document.getElementById("gradeValue").value = editRow.dataset.value;
                document.getElementById("gradeWeight").value = editRow.dataset.weight;
                document.getElementById("gradeCounts").checked = (editRow.dataset.counts === "true");
                document.getElementById("grade-popup-save-btn").textContent = "Save";
            } else {
                document.getElementById("grade-popup-title").textContent = "Add Grade";
                document.getElementById("gradeName").value = "";
                document.getElementById("gradeValue").value = "";
                document.getElementById("gradeWeight").value = "1";
                document.getElementById("gradeCounts").checked = true;
                document.getElementById("grade-popup-save-btn").textContent = "Add";
            }
        }

        function closeGradePopup() {
            document.getElementById("overlay").style.display = "none";
            document.getElementById("grade-popup").style.display = "none";
        }
        
        function closeSubjectPopup() {
            document.getElementById("subject-popup").style.display = "none";
            document.getElementById("overlay").style.display = "none";
        }

        function saveSubjectEdit() {
            if (editingSubjectHeader && editingSubjectContainer) {
                const newName = document.getElementById("subjectNameEdit").value.trim();
                const newCountsAverage = document.getElementById("subjectCountsAverage").checked;

                if (newName) {
                    editingSubjectHeader.textContent = newName;
                    
                    editingSubjectContainer.dataset.countsAverage = newCountsAverage; 
                    
                    const avgSpan = editingSubjectContainer.querySelector(".dropdown-header .average");
                    
                    if (newCountsAverage) {
                        const gradesList = editingSubjectContainer.querySelector(".grades-list");
                        updateSubjectAverage(gradesList, avgSpan, editingSubjectContainer.closest('.semester'));
                    } else {
                        avgSpan.textContent = "Non-Counting";
                        updateSemesterAverage(editingSubjectContainer.closest('.semester'));
                    }
                }
            }
            closeSubjectPopup();
            saveAllSemestersToBackend();
        }

        function editGradeRow(btn) {
            const gradeRow = btn.parentElement;
            const gradesList = gradeRow.parentElement;
            currentSubjectForGrade = {
                gradesList: gradesList,
                avgSpan: gradesList.parentElement.parentElement.querySelector('.average'),
                semesterDiv: gradesList.closest('.semester')
            };
            openGradePopup(gradeRow);
        }
        
        function deleteGradeRow(btn) {
            const gradeRow = btn.parentElement;
            const gradesList = gradeRow.parentElement;
            const avgSpan = gradesList.parentElement.parentElement.querySelector('.average');
            const semesterDiv = gradesList.closest('.semester');
            
            gradeRow.remove();
            updateSubjectAverage(gradesList, avgSpan, semesterDiv);
            saveAllSemestersToBackend();
        }


        // --- Grade Rendering and Average Logic ---

        function renderGradeRow(gradesList, name, value, weight, counts, gradeRow = null) {
            const isNew = !gradeRow;
            if (isNew) {
                gradeRow = document.createElement("div");
                gradeRow.className = "grade-row";
                gradesList.appendChild(gradeRow);
            }
            
            gradeRow.innerHTML = `
                <span class="grade-name"><strong>${name}</strong></span>
                <span class="grade-value">Grade: ${value}</span>
                <span class="grade-weight">Weight: ${weight}</span>
                <span class="grade-counts">${counts ? "Counts" : "Doesn't count"}</span>
                <button class="edit-btn">Edit</button>
                <button class="delete-btn">Delete</button>
            `;
            gradeRow.dataset.name = name;
            gradeRow.dataset.value = value;
            gradeRow.dataset.weight = weight;
            gradeRow.dataset.counts = counts;
            
            const subjectContext = {
                gradesList: gradesList,
                avgSpan: gradesList.parentElement.parentElement.querySelector('.average'),
                semesterDiv: gradesList.closest('.semester')
            };

            gradeRow.querySelector('.edit-btn').onclick = function() {
                currentSubjectForGrade = subjectContext;
                openGradePopup(gradeRow);
            };
            gradeRow.querySelector('.delete-btn').onclick = function() {
                gradeRow.remove();
                updateSubjectAverage(subjectContext.gradesList, subjectContext.avgSpan, subjectContext.semesterDiv);
                saveAllSemestersToBackend();
            };
        }

        async function addOrEditGradeToSubject() {
            const name = document.getElementById("gradeName").value.trim();
            const value = parseFloat(document.getElementById("gradeValue").value);
            const weight = parseFloat(document.getElementById("gradeWeight").value);
            const counts = document.getElementById("gradeCounts").checked;

            // Validation for grade value
            if (value < 1.0 || value > 6.0) {
                alert("The grade value must be a number between 1.0 and 6.0 (inclusive).");
                return;
            }

            if (!name || isNaN(value) || isNaN(weight) || weight <= 0) {
                alert("Please enter valid grade details.");
                return;
            }

            renderGradeRow(currentSubjectForGrade.gradesList, name, value, weight, counts, editingGradeRow);
            
            updateSubjectAverage(currentSubjectForGrade.gradesList, currentSubjectForGrade.avgSpan, currentSubjectForGrade.semesterDiv);
            closeGradePopup();
            await saveAllSemestersToBackend();
        }

        function updateSubjectAverage(gradesList, avgSpan, semesterDiv) {
            const gradeRows = gradesList.querySelectorAll(".grade-row");
            const subjectDiv = gradesList.closest('.subject');
            const countsAverage = subjectDiv.dataset.countsAverage === "true";

            let total = 0, weightSum = 0, hasGrade = false;
            gradeRows.forEach(row => {
                if (row.dataset.counts === "true") {
                    const value = parseFloat(row.dataset.value);
                    const weight = parseFloat(row.dataset.weight);
                    total += value * weight;
                    weightSum += weight;
                    hasGrade = true;
                }
            });
            const avg = (weightSum && hasGrade) ? (total / weightSum).toFixed(2) : 0;
            
            if (countsAverage) {
                avgSpan.textContent = `Average: ${hasGrade ? avg : 0}`;
            } else {
                 avgSpan.textContent = "Non-Counting"; 
            }
            
            updateSemesterAverage(semesterDiv);
        }

        function updateSemesterAverage(semesterDiv) {
            if (!semesterDiv) return;
            const subjectDivs = semesterDiv.querySelectorAll(".subject");
            const semesterAvgSpan = semesterDiv.querySelector(".dropdown-header .average");
            let totalAvg = 0, count = 0;
            let totalPlusPoints = 0; 
            
            subjectDivs.forEach(subjectDiv => {
                if (subjectDiv.dataset.countsAverage === "false") {
                    return; 
                }

                const gradesList = subjectDiv.querySelector(".grades-list");
                if (gradesList && gradesList.querySelectorAll(".grade-row").length > 0) {
                    const avgSpan = subjectDiv.querySelector(".average");
                    const match = avgSpan.textContent.match(/Average: ([\d.]+)/);
                    
                    if (match && !isNaN(parseFloat(match[1]))) {
                        const avgValue = parseFloat(match[1]);
                        
                        if (avgValue > 0) { 
                            totalAvg += avgValue;
                            count++;
                            
                            // Plus Points Calculation
                            const roundedAvg = roundToHalf(avgValue);
                            totalPlusPoints += calculatePlusPoints(roundedAvg);
                        }
                    }
                }
            });
            
            const avg = count ? (totalAvg / count).toFixed(2) : 0;
            const pointsDisplay = totalPlusPoints.toFixed(1);
            
            // Display average and plus points
            if (semesterAvgSpan) semesterAvgSpan.textContent = `Average: ${avg} | Points: ${pointsDisplay}`;
        }

        // --- Backend Communication and Initialization ---

        async function loadSemestersFromBackend() {
            const response = await fetch("/api/noten");
            if (!response.ok) {
                console.error("Could not load grades.");
                return;
            }
            const semesters = await response.json();
            renderSemesters(semesters);
        }

        function renderSemesters(semesters) {
            const container = document.getElementById("semesters");
            container.innerHTML = "";
            
            semesterCounter = semesters.length;
            
            semesters.forEach(sem => {
                const semesterDiv = document.createElement("div");
                semesterDiv.className = "semester";
                semesterDiv.dataset.id = sem.id; 

                const header = document.createElement("div");
                header.className = "dropdown-header";
                header.innerHTML = `<span>${sem.name}</span><span class="average">Average: 0 | Points: 0.0</span>`;
                header.onclick = function() {
                    header.classList.toggle("open");
                    content.style.display = header.classList.contains("open") ? "block" : "none";
                };

                const content = document.createElement("div");
                content.className = "dropdown-content";
                content.style.display = "none";

                const subjectsContainer = document.createElement("div");
                subjectsContainer.className = "subjects-container";
                content.appendChild(subjectsContainer);

                sem.subjects.forEach(subject => {
                    addSubject(subjectsContainer, subject.name, subject.grades, subject.counts_average);
                });

                const addSubjectBtn = document.createElement("button");
                addSubjectBtn.textContent = "Add Subject";
                addSubjectBtn.className = "add-btn";
                addSubjectBtn.onclick = function() { addSubjectPrompt(subjectsContainer); };
                content.appendChild(addSubjectBtn);

                const deleteSemesterBtn = document.createElement("button");
                deleteSemesterBtn.textContent = "Delete Semester";
                deleteSemesterBtn.className = "delete-btn";
                deleteSemesterBtn.onclick = function() { openDeleteConfirm(semesterDiv); }; 
                content.appendChild(deleteSemesterBtn);

                semesterDiv.appendChild(header);
                semesterDiv.appendChild(content);
                container.appendChild(semesterDiv);
                
                updateSemesterAverage(semesterDiv);
            });
        }
        
        async function saveAllSemestersToBackend() {
            const semesters = [];
            document.querySelectorAll('.semester').forEach(semesterDiv => {
                const semesterName = semesterDiv.querySelector('.dropdown-header span').textContent.trim();
                const subjects = [];
                
                semesterDiv.querySelectorAll('.subject').forEach(subjectDiv => {
                    const subjectName = subjectDiv.querySelector('.subject-title').textContent.trim();
                    const countsAverage = subjectDiv.dataset.countsAverage === "true"; 
                    const grades = [];
                    
                    subjectDiv.querySelectorAll('.grade-row').forEach(gradeRow => {
                        grades.push({
                            name: gradeRow.dataset.name,
                            value: parseFloat(gradeRow.dataset.value),
                            weight: parseFloat(gradeRow.dataset.weight),
                            counts: gradeRow.dataset.counts === "true"
                        });
                    });
                    subjects.push({ 
                        name: subjectName, 
                        grades: grades,
                        counts_average: countsAverage 
                    });
                });
                semesters.push({ name: semesterName, subjects });
            });

            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

            await fetch("/api/noten", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRF-Token": csrfToken
                },
                body: JSON.stringify(semesters)
            });
        }
        
        document.addEventListener("DOMContentLoaded", async function() {
            await loadSemestersFromBackend();
        });
    </script>
</body>
</html>