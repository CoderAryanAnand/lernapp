<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ session.get('csrf_token', '') }}">
    <title>Agenda</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='output.css') }}">
    <!-- FullCalendar JS -->
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.15/index.global.min.js'></script>

    <!-- Custom CSS for FullCalendar Theming -->
    <style>
        /* Light Mode Variables */
        :root {
            --fc-bg-color: #ffffff;
            --fc-border-color: #e2e8f0; /* zinc-200 */
            --fc-text-color: #3f3f46;   /* zinc-700 */
            --fc-title-text-color: #18181b; /* zinc-900 */
            --fc-today-bg-color: rgba(37, 99, 235, 0.05); /* blue-600 with opacity */
            --fc-event-bg-color: #3b82f6;
            --fc-event-border-color: #2563eb;
            --fc-event-text-color: #ffffff;
        }
        /* Dark Mode Variables */
        .dark {
            --fc-bg-color: #18181b; /* zinc-900 */
            --fc-border-color: #3f3f46; /* zinc-700 */
            --fc-text-color: #d4d4d8;   /* zinc-300 */
            --fc-title-text-color: #ffffff; /* white */
            --fc-today-bg-color: rgba(59, 130, 246, 0.1); /* blue-500 with opacity */
        }
        #calendar {
            background-color: var(--fc-bg-color);
            color: var(--fc-text-color);
        }
        .fc .fc-toolbar-title { color: var(--fc-title-text-color); }
        .fc .fc-button-primary { background-color: #2563eb; border-color: #2563eb; }
        .fc .fc-button-primary:hover { background-color: #1d4ed8; border-color: #1d4ed8; }
        .fc .fc-daygrid-day.fc-day-today { background-color: var(--fc-today-bg-color); }
        .fc th, .fc td, .fc hr, .fc thead, .fc tbody, .fc-scrollgrid { border-color: var(--fc-border-color); }
        /* Fix for day header and corner cell background color in dark mode */
        .fc .fc-col-header-cell, .fc .fc-timegrid-axis { background-color: var(--fc-bg-color); }
        /* Fix for day header text color in dark mode (Month and Week/Day views) */
        .fc .fc-col-header-cell-cushion, .fc-col-header-cell > a { color: var(--fc-text-color); }
    </style>
</head>
<body class="bg-zinc-100 dark:bg-zinc-900 font-sans">
    <!-- Main layout container -->
    <div class="md:flex">
        <!-- Include the reusable navbar component -->
        {% include '_navbar.html' %}

        <!-- Main Content Area -->
        <main class="flex-grow p-8">
            <h1 class="text-4xl font-bold text-zinc-800 dark:text-white mb-8">Ihre wöchentliche Agenda</h1>
            
            <!-- Action Buttons -->
            <div class="flex flex-wrap gap-3 mb-6">
                <button id="import-ics-button" onclick="document.getElementById('ics-file-input').click()" class="px-4 py-2 font-semibold text-white bg-blue-600 rounded-lg hover:bg-blue-700">.ics-Datei importieren</button>
                <input type="file" id="ics-file-input" accept=".ics" class="hidden" onchange="importICSFile(event)">
                <button id="run-scheduler-btn" class="px-4 py-2 font-semibold text-white bg-green-600 rounded-lg hover:bg-green-700">Lernzeit-Algorithmus ausführen</button>
                <button onclick="exportICS()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-700 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-600">.ics exportieren</button>
            </div>

            <!-- Calendar Container -->
            <div id="calendar-container" class="bg-white dark:bg-zinc-900 p-4 rounded-xl shadow-md">
                <div id="calendar"></div>
            </div>
        </main>
    </div>

    <!-- Overlay for all modals -->
    <div id="overlay" class="hidden fixed inset-0 bg-black bg-opacity-50 z-40"></div>

    <!-- Scheduler Results Modal -->
    <div id="scheduler-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-lg p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
        <h3 class="text-2xl font-bold text-zinc-900 dark:text-white mb-4">Planungsergebnisse</h3>
        <div id="scheduler-message" class="text-sm text-zinc-700 dark:text-zinc-300 max-h-80 overflow-y-auto pr-2"></div>
        <div class="flex justify-end mt-6">
            <button onclick="closeAllPopups()" class="px-4 py-2 font-semibold text-zinc-700 dark:text-zinc-200 bg-zinc-200 dark:bg-zinc-600 rounded-lg hover:bg-zinc-300 dark:hover:bg-zinc-500">Schliessen</button>
        </div>
    </div>

    <!-- Edit Event Modal -->
    <div id="event-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
        <h3 class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Termin bearbeiten</h3>
        <form id="edit-event-form" class="space-y-4">
            <input type="hidden" id="event-id" name="id">
            <input type="hidden" id="recurrence-id" name="recurrence-id">
            <div>
                <label for="event-title" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Titel</label>
                <input type="text" id="event-title" name="title" required class="mt-1 w-full input-styled">
            </div>
            <div class="flex items-center justify-between">
                <label for="event-color" class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Farbe <span class="text-xs" title="Die Farbe wird nur verwendet, wenn die Priorität die höchste Stufe hat.">ℹ️</span></label>
                <input type="color" id="event-color" name="color" class="w-10 h-10 p-0 border-none rounded-md bg-transparent">
            </div>
            <div>
                <label for="edit-event-priority" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Priorität</label>
                <select id="edit-event-priority" name="priority" class="mt-1 w-full input-styled">
                    {% for prio in priority_levels %}<option value="{{ prio.priority_level }}">{{ prio.priority_level }}</option>{% endfor %}
                    <option value="{{ priority_levels[-1].priority_level + 1 }}">{{ priority_levels[-1].priority_level + 1 }} (Nicht lernbezogen)</option>
                </select>
            </div>
            <div>
                <label for="event-start" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Start</label>
                <input type="datetime-local" id="event-start" name="start" required class="mt-1 w-full input-styled">
            </div>
            <div>
                <label for="event-end" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Ende</label>
                <input type="datetime-local" id="event-end" name="end" class="mt-1 w-full input-styled">
            </div>
            <label class="flex items-center space-x-2 text-zinc-700 dark:text-zinc-300">
                <input type="checkbox" id="edit-all-day" name="all_day" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span>Ganztägig</span>
            </label>
            <div>
                <label for="edit-recurrence" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Wiederholung bearbeiten</label>
                <select id="edit-recurrence" name="edit-recurrence" class="mt-1 w-full input-styled">
                    <option value="this">Nur diesen Termin</option>
                    <option value="all">Alle wiederkehrenden Termine</option>
                </select>
            </div>
            <div class="pt-4 flex flex-wrap-reverse gap-3 justify-end">
                <button type="button" onclick="closeAllPopups()" class="btn-secondary">Abbrechen</button>
                <button type="button" onclick="deleteEvent()" class="btn-danger">Löschen</button>
                <button type="button" onclick="deleteRecurringEvents()" class="btn-danger">Serie löschen</button>
                <button type="submit" class="btn-primary">Speichern</button>
            </div>
        </form>
    </div>

    <!-- Create Event Modal -->
    <div id="create-popup" class="hidden fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-full max-w-md p-6 bg-white dark:bg-zinc-800 rounded-xl shadow-lg z-50">
        <h3 class="text-2xl font-bold text-zinc-900 dark:text-white mb-6">Termin erstellen</h3>
        <form id="create-event-form" class="space-y-4">
            <div>
                <label for="create-title" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Titel</label>
                <input type="text" id="create-title" name="title" required class="mt-1 w-full input-styled">
            </div>
            <div class="flex items-center justify-between">
                <label for="create-color" class="text-sm font-medium text-zinc-700 dark:text-zinc-300">Farbe <span class="text-xs" title="Die Farbe wird nur verwendet, wenn die Priorität die höchste Stufe hat.">ℹ️</span></label>
                <input type="color" id="create-color" name="color" class="w-10 h-10 p-0 border-none rounded-md bg-transparent">
            </div>
            <div>
                <label for="create-event-priority" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Priorität</label>
                <select id="create-event-priority" name="priority" class="mt-1 w-full input-styled">
                    {% for prio in priority_levels %}<option value="{{ prio.priority_level }}">{{ prio.priority_level }}</option>{% endfor %}
                    <option value="{{ priority_levels[-1].priority_level + 1 }}">{{ priority_levels[-1].priority_level + 1 }} (Nicht lernbezogen)</option>
                </select>
            </div>
            <div>
                <label for="create-start" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Start</label>
                <input type="datetime-local" id="create-start" name="start" required class="mt-1 w-full input-styled">
            </div>
            <div>
                <label for="create-end" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Ende</label>
                <input type="datetime-local" id="create-end" name="end" class="mt-1 w-full input-styled">
            </div>
            <div>
                <label for="recurrence" class="block text-sm font-medium text-zinc-700 dark:text-zinc-300">Wiederholung</label>
                <select id="recurrence" name="recurrence" class="mt-1 w-full input-styled">
                    <option value="none">Keine</option>
                    <option value="daily">Täglich</option>
                    <option value="weekly">Wöchentlich</option>
                    <option value="monthly">Monatlich</option>
                </select>
            </div>
            <label class="flex items-center space-x-2 text-zinc-700 dark:text-zinc-300">
                <input type="checkbox" id="all-day" name="all_day" class="h-4 w-4 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                <span>Ganztägig</span>
            </label>
            <div class="pt-4 flex flex-wrap-reverse gap-3 justify-end">
                <button type="button" onclick="closeAllPopups()" class="btn-secondary">Abbrechen</button>
                <button type="submit" class="btn-primary">Erstellen</button>
            </div>
        </form>
    </div>

    <script src="{{ url_for('static', filename='js/agenda.js') }}"></script>
</body>
</html>